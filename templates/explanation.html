{% extends "base_sidebar.html" %}

{% block title %}Explanation - Heart Disease Prediction{% endblock %}

{% block content %}
<style>
    .container {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 0 1rem;
    }

    .card {
        background: var(--glass-bg);
        backdrop-filter: blur(var(--glass-blur));
        border: 1.5px solid var(--divider-color);
        border-radius: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.18);
    }

    .card-header {
        background: rgba(255, 255, 255, 0.05);
        border-bottom: 1.5px solid var(--divider-color);
        padding: 1.5rem;
        border-radius: 1.5rem 1.5rem 0 0;
    }

    .card-header h3, .card-header h4 {
        color: var(--primary-color);
        margin: 0;
        font-weight: 600;
    }

    .card-body {
        padding: 1.5rem;
        color: #f3f6fa;
    }

    .alert {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--divider-color);
        color: #f3f6fa;
        border-radius: 1rem;
        padding: 1rem;
        margin-bottom: 1.5rem;
    }

    .alert-info {
        border-left: 4px solid var(--primary-color);
    }

    .risk-summary-card {
        background: var(--glass-bg);
        border: 1.5px solid var(--divider-color);
        border-radius: 1.5rem;
        padding: 2rem;
        margin-bottom: 2rem;
        text-align: center;
    }

    .risk-level {
        color: var(--primary-color);
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 1rem;
    }

    .risk-type {
        color: #f3f6fa;
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 1rem;
        text-shadow: 0 2px 8px rgba(126, 203, 255, 0.3);
    }

    .risk-probability {
        color: var(--hover-color);
        font-size: 3.5rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
    }

    .risk-description {
        color: #bdbddd;
        font-size: 1.1rem;
        line-height: 1.6;
    }

    .table {
        color: #f3f6fa;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 1rem;
        overflow: hidden;
    }

    .table th {
        background: rgba(126, 203, 255, 0.1);
        color: var(--primary-color);
        font-weight: 600;
        border-color: var(--divider-color);
    }

    .table td {
        border-color: var(--divider-color);
    }

    .accordion {
        background: rgba(255, 255, 255, 0.03);
        border-radius: 1rem;
        overflow: hidden;
    }

    .accordion-item {
        background: transparent;
        border: 1px solid var(--divider-color);
    }

    .accordion-button {
        background: rgba(126, 203, 255, 0.1);
        color: var(--primary-color);
        font-weight: 600;
    }

    .accordion-button:not(.collapsed) {
        background: rgba(126, 203, 255, 0.15);
        color: var(--hover-color);
    }

    .accordion-body {
        background: rgba(255, 255, 255, 0.03);
        color: #f3f6fa;
    }

    .list-group-item {
        background: rgba(255, 255, 255, 0.03);
        border-color: var(--divider-color);
        color: #f3f6fa;
    }

    .badge {
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: 600;
    }

    .badge.bg-danger {
        background: rgba(255, 107, 107, 0.2) !important;
        color: #ff6b6b;
    }

    .badge.bg-warning {
        background: rgba(255, 215, 0, 0.2) !important;
        color: #ffd700;
    }

    .badge.bg-success {
        background: rgba(127, 255, 212, 0.2) !important;
        color: #7fffd4;
    }

    .btn-primary {
        background: var(--accent-gradient);
        border: none;
        color: var(--bg-dark);
        padding: 0.75rem 1.5rem;
        border-radius: 0.8rem;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(126, 203, 255, 0.3);
    }

    .btn-secondary {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid var(--divider-color);
        color: #f3f6fa;
        padding: 0.75rem 1.5rem;
        border-radius: 0.8rem;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.15);
        color: var(--primary-color);
    }

    .img-fluid {
        border-radius: 1rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    @media (max-width: 768px) {
        .container {
            margin: 1rem auto;
        }
        
        .card {
            margin-bottom: 1.5rem;
        }
        
        .risk-type {
            font-size: 2rem;
        }
        
        .risk-probability {
            font-size: 2.5rem;
        }
    }

    .boxplot-card {
        background: #fff;
        border-radius: 1.2rem;
        box-shadow: 0 4px 24px rgba(35,41,70,0.10);
        padding: 1.5rem 1.2rem;
        margin-bottom: 1rem;
        text-align: center;
        border: 1px solid #f0f0f0;
    }
    .boxplot-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: #232946;
        margin-bottom: 0.5rem;
    }
</style>

<div class="container">
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header">
                    <h3>Understanding Your Heart Disease Risk Prediction</h3>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <span class="alert-message">
                            <p>This explanation shows how we arrived at this prediction using machine learning models.</p>
                        </span>
                    </div>

                    {% if explanation.assessment_type in ['quick_form', 'quick_assessment'] %}
                        <!-- QUICK ASSESSMENT: Show summary, graphs, and download/back buttons -->
                        <div class="risk-summary-card">
                            <div class="risk-level">Risk Level: {{ explanation['risk_level'] }}</div>
                            <div class="risk-type">Quick Assessment Model</div>
                            <div class="risk-probability">{{ (explanation.probability * 100) | round(1) }}%</div>
                            <div class="risk-description">{{ explanation.risk_description }}</div>
                        </div>
                        
                        <!-- Key Risk Factors Chart -->
                        {% if explanation.key_risk_factors_img %}
                        <div class="card">
                            <div class="card-header">
                                <h4>Key Risk Factors</h4>
                            </div>
                            <div class="card-body">
                                <div class="text-center">
                                    <img src="data:image/png;base64,{{ explanation.key_risk_factors_img }}" alt="Key Risk Factors" class="img-fluid">
                                </div>
                                <div class="chart-explanation mt-3">
                                    <p>{{ explanation.get('key_risk_factors_explanation', 'These are the most significant factors contributing to your heart disease risk. Higher scores indicate greater influence on your risk profile.') }}</p>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Feature Impact Analysis -->
                        {% if explanation.risk_factor_img %}
                        <div class="card">
                            <div class="card-header">
                                <h4>Feature Impact Analysis</h4>
                            </div>
                            <div class="card-body">
                                <div class="text-center">
                                    <img src="data:image/png;base64,{{ explanation.risk_factor_img }}" alt="Feature Impact Analysis" class="img-fluid">
                                </div>
                                <div class="chart-explanation mt-3">
                                    <p>{{ explanation.get('feature_impact_explanation', 'This chart shows how your health parameters impact your overall risk assessment based on their importance and your specific values.') }}</p>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Comparison with Similar Cases -->
                        {% if explanation.boxplots %}
                        <div class="card">
                            <div class="card-header">
                                <h4>Comparison with Similar Cases</h4>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    {% for feature in ['age', 'sex', 'trestbps', 'chol', 'thalach', 'oldpeak'] %}
                                    {% if explanation.boxplots and explanation.boxplots[feature] %}
                                    <div class="col-md-6 mb-4">
                                        <div class="boxplot-card">
                                            <div class="boxplot-title">Comparison for {{ feature|replace('_', ' ')|title }}</div>
                                            <img src="data:image/png;base64,{{ explanation.boxplots[feature] }}" alt="Boxplot for {{ feature }}" class="img-fluid" />
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                                <div class="chart-explanation mt-3">
                                    <p>{{ explanation.get('comparison_explanation', 'This section compares your health metrics to those of similar patients. If your values are outside the typical range, it may indicate higher or lower risk compared to your peers.') }}</p>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="card">
                            <div class="card-header">
                                <h4>How was this calculated?</h4>
                            </div>
                            <div class="card-body">
                                <p>This result was generated using a streamlined AI model trained on the most important health features you provided. For a more comprehensive analysis, please complete the detailed assessment.</p>
                                <ul>
                                    <li><b>Model Used:</b> Random Forest (Quick Assessment)</li>
                                    <li><b>Features Considered:</b> Age, Sex, Resting Blood Pressure, Cholesterol, Max Heart Rate, ST Depression</li>
                                </ul>
                                {% if not is_admin_view %}
                                <a href="/risk_assessment" class="btn btn-primary mt-2">Try Detailed Assessment</a>
                                {% endif %}
                            </div>
                        </div>
                        <div class="text-center mt-4 mb-4">
                            {% if is_admin_view %}
                            <a href="{{ url_for('admin_all_reports') }}" class="btn btn-primary">
                                <i class="bi bi-arrow-left me-2"></i>Back to Reports
                            </a>
                            {% else %}
                            <a href="{{ url_for('index') }}" class="btn btn-primary">
                                <i class="bi bi-house me-2"></i>Back to Home
                            </a>
                            {% endif %}
                        </div>
                    {% else %}
                        <!-- DETAILED ASSESSMENT: Show all detailed sections as before -->
                        <!-- Risk Assessment Summary Card -->
                        <div class="risk-summary-card">
                            <div class="risk-level">Risk Level: {{ explanation['risk_level'] }}</div>
                            <div class="risk-type">{{ explanation.risk_type }}</div>
                            <div class="risk-probability">{{ (explanation.probability * 100) | round(1) }}%</div>
                            <div class="risk-description">{{ explanation.risk_description }}</div>
                        </div>
                        <!-- Detailed Analysis Section -->
                        <div class="card">
                            <div class="card-header">
                                <h4>Detailed Analysis</h4>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h5 class="text-primary">Model Consensus</h5>
                                        <p>Our system uses three different machine learning models to provide a more reliable prediction:</p>
                                        <div class="table-responsive">
                                            <table class="table">
                                                <thead>
                                                    <tr>
                                                        <th>Model</th>
                                                        <th>Risk Assessment</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td>KNN Model</td>
                                                        <td>{{ knn_probability|default(0)|round(2) }}% Risk ({{ knn_risk|default('Unknown') }})</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Random Forest Model</td>
                                                        <td>{{ rf_probability|default(0)|round(2) }}% Risk ({{ rf_risk|default('Unknown') }})</td>
                                                    </tr>
                                                    <tr>
                                                        <td>XGBoost Model</td>
                                                        <td>{{ xgb_probability|default(0)|round(2) }}% Risk ({{ xgb_risk|default('Unknown') }})</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h5 class="text-primary">Model Explanations</h5>
                                        <div class="accordion" id="modelExplanations">
                                            <div class="accordion-item">
                                                <h2 class="accordion-header">
                                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#knnExplanation">
                                                        KNN Model Details
                                                    </button>
                                                </h2>
                                                <div id="knnExplanation" class="accordion-collapse collapse show" data-bs-parent="#modelExplanations">
                                                    <div class="accordion-body">
                                                        {{ explanation.get('model_insights', {}).get('knn', {}).get('explanation_text', 'No detailed explanation available for KNN.') }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="accordion-item">
                                                <h2 class="accordion-header">
                                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#rfExplanation">
                                                        Random Forest Details
                                                    </button>
                                                </h2>
                                                <div id="rfExplanation" class="accordion-collapse collapse" data-bs-parent="#modelExplanations">
                                                    <div class="accordion-body">
                                                        {{ explanation.get('model_insights', {}).get('random_forest', {}).get('explanation_text', 'No detailed explanation available for Random Forest.') }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="accordion-item">
                                                <h2 class="accordion-header">
                                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#xgbExplanation">
                                                        XGBoost Details
                                                    </button>
                                                </h2>
                                                <div id="xgbExplanation" class="accordion-collapse collapse" data-bs-parent="#modelExplanations">
                                                    <div class="accordion-body">
                                                        {{ explanation.get('model_insights', {}).get('xgboost', {}).get('explanation_text', 'No detailed explanation available for XGBoost.') }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Key Risk Factors Analysis Section -->
                        <div class="card">
                            <div class="card-header">
                                <h4><i class="bi bi-graph-up me-2"></i>Key Risk Factors Analysis</h4>
                            </div>
                            <div class="card-body">
                                <!-- Your Key Risk Factors - Full Width -->
                                <div class="mb-5">
                                    <h5 class="text-primary mb-4 text-center">
                                        <i class="bi bi-bar-chart me-2"></i>Your Key Risk Factors
                                    </h5>
                                    {% if explanation.key_risk_factors_img %}
                                    <div class="text-center">
                                        <div class="chart-container" style="position: relative; height: 450px; width: 100%; max-width: 900px; margin: 0 auto;">
                                            <img src="data:image/png;base64,{{ explanation.key_risk_factors_img }}" 
                                                 alt="Key Risk Factors" 
                                                 class="img-fluid rounded shadow" 
                                                 style="max-height: 450px; max-width: 900px; width: auto; height: auto; object-fit: contain;">
                                        </div>
                                    </div>
                                    {% else %}
                                    <div class="text-center p-4" style="background: rgba(255, 255, 255, 0.05); border-radius: 0.75rem; border: 1px solid rgba(255, 255, 255, 0.1); min-height: 350px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                                        <i class="bi bi-bar-chart text-muted" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                                        <p class="text-muted mb-2">Risk factors visualization not available</p>
                                        <small class="text-muted">This chart would show your key risk factors with their individual scores.</small>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Risk Factors List 
                                    <div class="risk-factors-list mt-4">
                                        {% for feature, data in explanation.get('key_factors', {}).items() %}
                                        <div class="risk-factor-item mb-3 p-3 border rounded" style="background: rgba(255, 255, 255, 0.05); border-color: rgba(255, 255, 255, 0.1) !important;">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <strong class="text-light">{{ feature|replace('_', ' ')|title }}</strong>
                                                <span class="badge {% if data['risk_level'] == 'high' %}bg-danger{% elif data['risk_level'] == 'medium' %}bg-warning{% else %}bg-success{% endif %}">
                                                    {{ data['risk_level']|title }}
                                                </span>
                                            </div>
                                            <p class="mb-0 mt-2 small text-muted">{{ data.description }}</p>
                                        </div>
                                        {% endfor %}
                                    </div>-->
                                </div>

                                <!-- Feature Importance - Full Width -->
                                <div class="mb-4">
                                    <h5 class="text-primary mb-4 text-center">
                                        <i class="bi bi-pie-chart me-2"></i>Feature Importance Analysis
                                    </h5>
                                    {% if explanation.feature_importance_img %}
                                    <div class="text-center">
                                        <div class="chart-container" style="position: relative; height: 450px; width: 100%; max-width: 800px; margin: 0 auto;">
                                            <img src="data:image/png;base64,{{ explanation.feature_importance_img }}" 
                                                 alt="Feature Importance" 
                                                 class="img-fluid rounded shadow" 
                                                 style="max-height: 450px; max-width: 800px; width: auto; height: auto; object-fit: contain;">
                                        </div>
                                    </div>
                                    <div class="mt-3 text-center">
                                        <p class="text-muted mb-0">
                                            <i class="bi bi-info-circle me-2"></i>
                                            This chart shows the relative importance of each health factor in the prediction model.
                                        </p>
                                    </div>
                                    {% else %}
                                    <div class="text-center p-4" style="background: rgba(255, 255, 255, 0.05); border-radius: 0.75rem; border: 1px solid rgba(255, 255, 255, 0.1); min-height: 300px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                                        <i class="bi bi-pie-chart text-muted" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                                        <p class="text-muted mb-2">Feature importance visualization not available</p>
                                        <small class="text-muted">This chart would show the relative importance of each health factor in the prediction model.</small>
                                        
                                        <!-- Fallback: Show top features in a simple list -->
                                        {% if explanation.get('key_factors') %}
                                        <div class="mt-3" style="text-align: left; width: 100%;">
                                            <h6 class="text-light mb-2">Top Risk Factors:</h6>
                                            <div class="feature-list">
                                                {% for feature, data in explanation.get('key_factors', {}).items() %}
                                                <div class="feature-item mb-2 p-2" style="background: rgba(255, 255, 255, 0.03); border-radius: 0.5rem; border: 1px solid rgba(255, 255, 255, 0.1);">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <span class="text-light small">{{ feature|replace('_', ' ')|title }}</span>
                                                        <span class="badge {% if data['risk_level'] == 'high' %}bg-danger{% elif data['risk_level'] == 'medium' %}bg-warning{% else %}bg-success{% endif %} small">
                                                            {{ data['risk_level']|title }}
                                                        </span>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Explanation Section -->
                                <div class="chart-explanation mt-4" style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.1), rgba(255, 193, 7, 0.05)); color: #ffc107; font-size: 1rem; font-weight: 500; padding: 1.5rem; border-radius: 0.75rem; border: 1px solid rgba(255, 193, 7, 0.2);">
                                    <strong><i class="bi bi-info-circle me-2"></i>Understanding Your Risk Factors:</strong> These are the most significant factors contributing to your heart disease risk. Higher scores indicate greater influence on your risk profile. Review each factor to understand where your main risks lie and discuss them with your healthcare provider.
                                </div>
                            </div>
                        </div>
                        <!-- Feature Impact Analysis Section -->
                        <div class="card">
                            <div class="card-header">
                                <h4><i class="bi bi-activity me-2"></i>Feature Impact Analysis</h4>
                            </div>
                            <div class="card-body">
                                <div class="text-center">
                                    {% if explanation.risk_factor_img %}
                                    <div class="chart-container" style="position: relative; height: 450px; width: 100%; max-width: 600px; margin: 0 auto;">
                                        <img src="data:image/png;base64,{{ explanation.risk_factor_img }}" 
                                             alt="Feature Impact Analysis" 
                                             class="img-fluid rounded shadow" 
                                             style="max-height: 450px; max-width: 600px; width: auto; height: auto; object-fit: contain;">
                                    </div>
                                    {% else %}
                                    <div class="text-center p-5" style="background: rgba(255, 255, 255, 0.05); border-radius: 0.75rem; border: 1px solid rgba(255, 255, 255, 0.1); min-height: 400px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                                        <i class="bi bi-activity text-muted" style="font-size: 4rem; margin-bottom: 1rem;"></i>
                                        <p class="text-muted mb-2">Feature impact analysis visualization not available</p>
                                        <small class="text-muted">This chart would show how your health parameters impact your overall risk assessment.</small>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="chart-explanation mt-4" style="background: linear-gradient(135deg, rgba(13, 202, 240, 0.1), rgba(13, 202, 240, 0.05)); color: #0dcaf0; font-size: 1rem; font-weight: 500; padding: 1.5rem; border-radius: 0.75rem; border: 1px solid rgba(13, 202, 240, 0.2);">
                                    <strong><i class="bi bi-info-circle me-2"></i>Feature Impact Analysis:</strong> This chart shows how your health parameters impact your overall risk assessment based on their importance and your specific values. Features with higher impact scores are more influential in your risk prediction. Understanding these impacts can help you focus on the most critical health factors.
                                </div>
                            </div>
                        </div>
                        <!-- Key Health Parameters Section - 3+2 Grid Layout -->
                        <div class="card">
                            <div class="card-header">
                                <h4><i class="bi bi-clipboard-data me-2"></i>Key Health Parameters</h4>
                            </div>
                            <div class="card-body">
                                <p class="text-center text-muted mb-4">Your key health parameters and their clinical interpretations:</p>
                                
                                <!-- First Row - 3 Parameters -->
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <div class="parameter-card" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05)); border-radius: 0.75rem; padding: 1.5rem; border: 1px solid rgba(255, 255, 255, 0.2); height: 120px;">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <h6 class="text-light mb-0">Ca</h6>
                                                <div class="toggle-switch" style="width: 40px; height: 20px; background: #28a745; border-radius: 20px; position: relative;">
                                                    <div style="width: 16px; height: 16px; background: white; border-radius: 50%; position: absolute; top: 2px; right: 2px;"></div>
                                                </div>
                                            </div>
                                            <p class="text-muted small mb-0">Number of major vessels colored by fluoroscopy</p>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="parameter-card" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05)); border-radius: 0.75rem; padding: 1.5rem; border: 1px solid rgba(255, 255, 255, 0.2); height: 120px;">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <h6 class="text-light mb-0">Thal</h6>
                                                <div class="toggle-switch" style="width: 40px; height: 20px; background: #28a745; border-radius: 20px; position: relative;">
                                                    <div style="width: 16px; height: 16px; background: white; border-radius: 50%; position: absolute; top: 2px; right: 2px;"></div>
                                                </div>
                                            </div>
                                            <p class="text-muted small mb-0">Thalassemia (3 = Normal, 6 = Fixed Defect, 7 = Reversible Defect)</p>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="parameter-card" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05)); border-radius: 0.75rem; padding: 1.5rem; border: 1px solid rgba(255, 255, 255, 0.2); height: 120px;">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <h6 class="text-light mb-0">Cp</h6>
                                                <div class="toggle-switch" style="width: 40px; height: 20px; background: #28a745; border-radius: 20px; position: relative;">
                                                    <div style="width: 16px; height: 16px; background: white; border-radius: 50%; position: absolute; top: 2px; right: 2px;"></div>
                                                </div>
                                            </div>
                                            <p class="text-muted small mb-0">Chest pain type (0 = Typical Angina, 1 = Atypical Angina, 2 = Non-anginal Pain, 3 = Asymptomatic)</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Second Row - 2 Parameters -->
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="parameter-card" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05)); border-radius: 0.75rem; padding: 1.5rem; border: 1px solid rgba(255, 255, 255, 0.2); height: 120px;">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <h6 class="text-light mb-0">Thalach</h6>
                                                <div class="toggle-switch" style="width: 40px; height: 20px; background: #28a745; border-radius: 20px; position: relative;">
                                                    <div style="width: 16px; height: 16px; background: white; border-radius: 50%; position: absolute; top: 2px; right: 2px;"></div>
                                                </div>
                                            </div>
                                            <p class="text-muted small mb-0">Maximum heart rate achieved</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="parameter-card" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05)); border-radius: 0.75rem; padding: 1.5rem; border: 1px solid rgba(255, 255, 255, 0.2); height: 120px;">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <h6 class="text-light mb-0">Oldpeak</h6>
                                                <div class="toggle-switch" style="width: 40px; height: 20px; background: #28a745; border-radius: 20px; position: relative;">
                                                    <div style="width: 16px; height: 16px; background: white; border-radius: 50%; position: absolute; top: 2px; right: 2px;"></div>
                                                </div>
                                            </div>
                                            <p class="text-muted small mb-0">ST depression induced by exercise relative to rest</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="chart-explanation mt-3" style="background: linear-gradient(135deg, rgba(33, 150, 243, 0.1), rgba(33, 150, 243, 0.05)); color: #2196f3; font-size: 0.9rem; font-weight: 500; padding: 1rem; border-radius: 0.5rem; border: 1px solid rgba(33, 150, 243, 0.2);">
                                    <strong><i class="bi bi-info-circle me-2"></i>Parameter Status:</strong> These parameters represent key clinical measurements used in your heart disease risk assessment. The toggle indicators show the relative significance of each parameter in your individual case.
                                </div>
                            </div>
                        </div>
                        <!-- Comparison with Similar Cases Section -->
                        <div class="card">
                            <div class="card-header">
                                <h4><i class="bi bi-people me-2"></i>Comparison with Similar Cases</h4>
                            </div>
                            <div class="card-body">
                                <p class="text-center text-muted mb-3">See how your health metrics compare to other patients with similar profiles:</p>
                                
                                {% for feature in ['age', 'sex', 'cp', 'trestbps', 'chol'] %}
                                {% if explanation.boxplots and explanation.boxplots[feature] %}
                                <div class="mb-3">
                                    <div class="boxplot-card p-3" style="background: rgba(255, 255, 255, 0.05); border-radius: 0.75rem; border: 1px solid rgba(255, 255, 255, 0.1); width: 100%;">
                                        <div class="boxplot-title mb-2 text-center" style="color: #f3f6fa; font-weight: 600; font-size: 1.1rem;">
                                            <i class="bi bi-graph-up me-2"></i>{{ feature|replace('_', ' ')|title }}
                                        </div>
                                        <div class="chart-container text-center" style="position: relative; height: 280px; width: 100%; margin: 0 auto;">
                                            <img src="data:image/png;base64,{{ explanation.boxplots[feature] }}" 
                                                 alt="Boxplot for {{ feature }}" 
                                                 class="img-fluid rounded shadow" 
                                                 style="max-height: 280px; width: 100%; height: auto; object-fit: contain;" />
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                {% endfor %}
                                
                                <div class="chart-explanation mt-3" style="background: linear-gradient(135deg, rgba(108, 117, 125, 0.1), rgba(108, 117, 125, 0.05)); color: #6c757d; font-size: 1rem; font-weight: 500; padding: 1rem; border-radius: 0.5rem; border: 1px solid rgba(108, 117, 125, 0.2);">
                                    <strong><i class="bi bi-info-circle me-2"></i>Comparative Analysis:</strong> This section compares your health metrics to those of similar patients in our database. If your values are outside the typical range, it may indicate higher or lower risk compared to your peers.
                                </div>
                            </div>
                        </div>
                        <!-- Explanation/Summary Section -->
                        <div class="card">
                            <div class="card-header">
                                <h4><i class="bi bi-clipboard-check me-2"></i>Assessment Summary</h4>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="summary-card text-center p-3" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05)); border-radius: 0.75rem; border: 1px solid rgba(255, 255, 255, 0.2);">
                                            <h6 class="text-primary mb-2">Risk Level</h6>
                                            <p class="text-light mb-0 fw-bold">{{ explanation.get('risk_level', 'Unknown') }}</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="summary-card text-center p-3" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05)); border-radius: 0.75rem; border: 1px solid rgba(255, 255, 255, 0.2);">
                                            <h6 class="text-primary mb-2">Probability</h6>
                                            <p class="text-light mb-0 fw-bold">{{ "%.1f"|format((explanation.get('probability', 0) * 100)) }}%</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="summary-card text-center p-3" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05)); border-radius: 0.75rem; border: 1px solid rgba(255, 255, 255, 0.2);">
                                            <h6 class="text-primary mb-2">Risk Type</h6>
                                            <p class="text-light mb-0 fw-bold">{{ explanation.get('risk_type', 'Moderate') }}</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="summary-card text-center p-3" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05)); border-radius: 0.75rem; border: 1px solid rgba(255, 255, 255, 0.2);">
                                            <h6 class="text-primary mb-2">Models Used</h6>
                                            <p class="text-light mb-0 fw-bold">3 ML Models</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="detailed-analysis mt-4" style="background: rgba(255, 255, 255, 0.05); border-radius: 0.75rem; padding: 1.5rem; border: 1px solid rgba(255, 255, 255, 0.1);">
                                    <h6 class="text-light mb-3"><i class="bi bi-file-text me-2"></i>Detailed Analysis</h6>
                                    <div class="analysis-text" style="color: #bdbddd; line-height: 1.6;">
                                        {% set detailed_text = explanation.get('explanation_text') or explanation.get('risk_description') %}
                                        {% if detailed_text %}
                                            {% set sentences = detailed_text.split('.') %}
                                            {% for sentence in sentences[:3] %}
                                                {% if sentence.strip() %}
                                                    <p class="mb-2">• {{ sentence.strip() }}.</p>
                                                {% endif %}
                                            {% endfor %}
                                        {% else %}
                                            <p class="mb-2">• Based on your health parameters, we've conducted a comprehensive analysis using three different machine learning models.</p>
                                            <p class="mb-2">• The assessment considers multiple factors including age, chest pain type, blood pressure, cholesterol levels, and cardiac test results.</p>
                                            <p class="mb-0">• Our recommendation is to consult with healthcare professionals for personalized medical advice.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Recommendations Section -->
                        <div class="card">
                            <div class="card-header">
                                <h4>Personalized Recommendations</h4>
                            </div>
                            <div class="card-body">
                                {% if explanation['risk_level'] == 'High' %}
                                    <div class="alert alert-danger">
                                        <span class="alert-message">
                                            <strong>High Risk:</strong> We strongly recommend you consult a doctor or cardiologist as soon as possible for further evaluation and management.
                                        </span>
                                    </div>
                                    <ul>
                                        <li>Schedule an immediate appointment with your healthcare provider.</li>
                                        <li>Monitor your blood pressure and heart rate daily.</li>
                                        <li>Keep a symptom diary to track any chest pain or discomfort.</li>
                                    </ul>
                                {% elif explanation['risk_level'] == 'Low' %}
                                    <div class="alert alert-success">
                                        <span class="alert-message">
                                            <strong>Low Risk:</strong> Your risk of heart disease is low. Maintain a healthy lifestyle to keep your heart healthy!
                                        </span>
                                    </div>
                                    <ul>
                                        <li>Continue regular physical activity.</li>
                                        <li>Eat a balanced, heart-healthy diet.</li>
                                        <li>Avoid smoking and limit alcohol consumption.</li>
                                        <li>Manage stress and get regular sleep.</li>
                                    </ul>
                                {% else %}
                                    <div class="alert alert-warning">
                                        <span class="alert-message">
                                            <strong>Moderate Risk:</strong> We recommend scheduling a routine check-up with your healthcare provider and following healthy lifestyle habits.
                                        </span>
                                    </div>
                                    <ul>
                                        <li>Schedule a follow-up with your healthcare provider within a week.</li>
                                        <li>Start monitoring your vital signs regularly.</li>
                                        <li>Review your current medications with your doctor.</li>
                                    </ul>
                                {% endif %}
                            </div>
                        </div>
                        <div class="text-center mt-4 mb-4">
                            {% if is_admin_view %}
                            <a href="{{ url_for('admin_all_reports') }}" class="btn btn-primary">
                                <i class="bi bi-arrow-left me-2"></i>Back to Reports
                            </a>
                            {% else %}
                            <a href="{{ url_for('index') }}" class="btn btn-primary">
                                <i class="bi bi-house me-2"></i>Back to Home
                            </a>
                            {% endif %}
                        </div>
                    {% endif %}

                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %} 